
**开发者文档**：https://opendeep.wiki/pgvector/pgvector/developer-guide
# JL优化

## sql层
注册sql语句，安排对应的C接口，可以在 sql/vector.sql 搜索jl看是怎么注册的，哪些函数复用了ivfflat
之后加其他优化算法也是类似的，这一层的工作不难

## GPU算子
1. 各种距离 L2距离 余弦距离
2. 矩阵乘法/稀疏矩阵乘法
3. 标准化
4. 排序,top-K?（这个感觉不太需要，从之前的经验来看这一步一般cpu做）

## C层
ivfjl.h/ivfjl.c 总体上复用的是ivfflat的逻辑

**ivfscan.c**
ivfflatbeginscan: 初始化扫描

ivfflatgettuple: 扫描的核心函数
    ->GetScanList: 选择最相关的n_probes个聚类，计算距离是通过堆来实现的
    ->GetScanItems: 从选定聚类中检索向量，计算距离并执行排序 **需要改成gpu版本**

ivfflatendscan: 结束扫描，释放资源

ivfflatrescan: 重新扫描，发生在使用同一个索引扫描描述符时
    对比ivfflatbeginscan，不需要分配新的内存和数据结构，开销较小

重排序：还没有看应该在哪里添加

**重要数据结构**
Vector: 向量数据结构
Datum: 一个通用数据容器，可以用来处理向量
    Q: 为什么有了vector结构还需要用这个Datum
    A: 所有postgresql扩展函数要求用Datum作为返回值
IvfflatScanOpaque: 保存扫描过程中的所有数据结构和状态

# cuvs
cuvs/cpp/src/neighbours里有很多值得参考的算法

## 目标和分工
**目标**：实现了ivfflat gpu版本，相比多线程有明显优势
1. 写算子，尽快拿出一个可用的算子库（包含矩阵乘法、L2距离、余弦距离、标准化） **尽可能参考cuvs**（龙俊宇）
2. 写ivfflat的并行查询逻辑 **尽可能参考cuvs**（章毅）
3. 注册Parallel语句，完整实现cpu版jl优化（刘宗熹）
4. 注册其他优化算法的sql语句、注册并行查询接口（之后视测试哪些函数而定）

**合作方式**：在我的仓库 https://github.com/mindtravel/pgvector.git 开发（fork我的仓库，完成一个模块后向刘宗熹提PR，我合并、测试）
